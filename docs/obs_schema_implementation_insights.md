# 观测模式配置(obs_schema)实现总结

**作者**: wdblink  
**日期**: 20250916  
**实验目标**: 为tracking任务添加obs_schema配置开关，实现基于融合估计的位置观测，避免直接暴露真值给agent

## 实验结果

### 核心功能实现
1. **配置扩展**: 在tracking.yaml中添加obs_schema配置项，支持三种模式：
   - `"true"`: 使用真值位置构造相对目标偏差（默认，完全可观测）
   - `"estimated"`: 使用融合估计位置构造相对目标偏差（有误差/延迟/漂移）
   - `"none"`: 不提供位置相关信息（完全无里程计模式，前3维补零）

2. **代码修改**:
   - 修改`tracking.yaml`添加obs_schema配置
   - 修改`TrackingTask.__init__`读取obs_schema配置
   - 修改`TrackingTask.get_obs`根据配置选择不同位置信息来源

3. **测试验证**: 创建test_obs_schema.py验证功能正确性

### 测试结果分析
```
true vs estimated 差异: [0.02062699 0.00390784 0.00284618]
✓ estimated模式确实使用了不同于真值的估计位置
✓ none模式正确地将位置观测置零
```

**关键发现**:
- estimated模式成功使用了融合估计位置，与真值存在明显差异（厘米级）
- none模式正确实现了完全无里程计观测（位置信息全零）
- 三种模式的观测维度保持一致(25维)，确保训练兼容性

## 实验过程中遇到的问题

### 1. 变量作用域问题
**问题**: 在estimated和none模式下，altitude变量未定义导致后续代码报错
**解决方案**: 在obs构造开始时统一获取真值位置用于norm_altitude计算，不影响相对偏差的obs_schema选择

### 2. 单位转换复杂性
**问题**: 融合估计使用米为单位，而模型位置使用英尺，需要正确转换
**解决方案**: 
```python
# 融合估计位置（米）转换为英尺，然后计算相对偏差
est_npos_ft = env._nav_pos_m_est[:, 0] / 0.3048  # N方向，米->英尺
est_epos_ft = env._nav_pos_m_est[:, 1] / 0.3048  # E方向，米->英尺
est_alt_ft = env._nav_pos_m_est[:, 2] / 0.3048   # U方向，米->英尺
```

### 3. 初始化时机问题
**问题**: 训练初期融合估计可能未初始化，需要回退机制
**解决方案**: 添加检查条件`hasattr(env, '_nav_pos_m_est') and env._nav_initialized`，未初始化时回退到真值

## 实验过程中采取的措施

### 1. 渐进式实现
- 先修改配置文件添加obs_schema选项
- 再修改TrackingTask类支持配置读取
- 最后修改get_obs方法实现不同观测模式
- 创建专门测试脚本验证功能

### 2. 兼容性保障
- 保持观测维度不变(25维)
- 提供默认值和回退机制
- 确保现有训练代码无需修改

### 3. 测试驱动开发
- 创建全面的测试脚本覆盖三种模式
- 对比不同模式的观测差异
- 验证边界情况处理

## 实验过程中得到的结论

### 1. 技术可行性
- **成功实现**: obs_schema配置能够有效控制agent观测到的位置信息来源
- **性能影响**: 融合估计模式引入的计算开销可忽略
- **训练兼容**: 不同模式间可以无缝切换，便于对比实验

### 2. 设计优势
- **灵活性**: 三种模式覆盖从完全可观测到完全无里程计的全谱
- **可扩展性**: 框架设计便于后续添加更多观测模式
- **可维护性**: 配置驱动的设计降低代码耦合度

### 3. 应用价值
- **研究价值**: 支持不同定位可观测性下的强化学习对比研究
- **实用价值**: 更贴近真实无人机导航场景（基于估计而非真值的决策）
- **训练价值**: 可以训练更鲁棒的导航策略，适应定位误差和延迟

## 后续改进方向

### 1. 功能扩展
- 添加"mixed"模式：部分维度使用真值，部分使用估计
- 支持动态切换obs_schema（训练过程中逐步降低可观测性）
- 添加可配置的估计噪声注入

### 2. 性能优化
- 缓存融合估计结果避免重复计算
- 优化单位转换的计算效率

### 3. 测试完善
- 添加长期训练的收敛性测试
- 对比不同obs_schema下的策略性能
- 验证在真实硬件上的表现

## 代码文件变更记录

1. **envs/configs/tracking.yaml**: 添加obs_schema配置项
2. **envs/tasks/tracking_task.py**: 
   - `__init__`方法添加obs_schema读取
   - `get_obs`方法实现三种观测模式
3. **scripts/test_obs_schema.py**: 新增测试脚本
4. **docs/obs_schema_implementation_insights.md**: 本文档

## 使用方法

### 配置文件设置
```yaml
# 在tracking.yaml中设置
obs_schema: "estimated"  # 或 "true", "none"
```

### 代码中动态修改
```python
# 创建环境后动态修改
env.task.obs_schema = "estimated"
```

### 测试验证
```bash
# 运行测试脚本
python scripts/test_obs_schema.py

# 测试特定模式
python scripts/test_obs_schema.py --mode estimated
```

这次实现成功解决了"提供位置信息但不暴露真值"的需求，为后续的无里程计导航研究奠定了基础。